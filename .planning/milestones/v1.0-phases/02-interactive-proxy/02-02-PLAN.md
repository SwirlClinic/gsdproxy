---
phase: 02-interactive-proxy
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/discord/components/permission-prompt.ts
  - src/discord/components/question-prompt.ts
  - src/bridge/permission-handler.ts
autonomous: true

must_haves:
  truths:
    - "Permission requests render as Discord embeds with tool name, input preview, and Allow/Deny buttons"
    - "AskUserQuestion renders as Discord select menus with option labels and descriptions"
    - "User can click Allow or Deny button to respond to a permission request"
    - "Unanswered permission prompts auto-deny after 5 minutes with timeout notification"
    - "User can select an answer from a question select menu and it gets returned"
  artifacts:
    - path: "src/discord/components/permission-prompt.ts"
      provides: "Discord ButtonBuilder/EmbedBuilder factories for permission prompts"
      exports: ["createPermissionEmbed", "createPermissionButtons"]
    - path: "src/discord/components/question-prompt.ts"
      provides: "Discord StringSelectMenuBuilder factory for AskUserQuestion"
      exports: ["createQuestionSelect"]
    - path: "src/bridge/permission-handler.ts"
      provides: "Permission handler that renders Discord prompts and collects responses"
      exports: ["PermissionHandler"]
  key_links:
    - from: "src/bridge/permission-handler.ts"
      to: "src/discord/components/permission-prompt.ts"
      via: "import createPermissionEmbed, createPermissionButtons"
      pattern: "createPermission"
    - from: "src/bridge/permission-handler.ts"
      to: "src/discord/components/question-prompt.ts"
      via: "import createQuestionSelect"
      pattern: "createQuestionSelect"
---

<objective>
Create the Discord interactive components (buttons, select menus, embeds) and the permission handler that renders them and collects user responses for tool permissions and AskUserQuestion prompts.

Purpose: These components are the user-facing side of the permission bridge. When Claude needs tool approval or asks a clarifying question, the user sees rich Discord UI elements and responds with a single click. The permission handler orchestrates the full lifecycle: render prompt, await response, handle timeout, return decision.

Output: Three new files providing Discord component factories and a PermissionHandler class.
</objective>

<execution_context>
@/Users/erictrang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/erictrang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interactive-proxy/02-RESEARCH.md
@src/discord/formatter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Discord component builders for permissions and questions</name>
  <files>src/discord/components/permission-prompt.ts, src/discord/components/question-prompt.ts</files>
  <action>
Create src/discord/components/ directory.

Create src/discord/components/permission-prompt.ts:
- Import ActionRowBuilder, ButtonBuilder, ButtonStyle, EmbedBuilder from discord.js
- Export function `createPermissionEmbed(toolName: string, input: Record<string, unknown>): EmbedBuilder`
  - Title: "Permission Request: {toolName}"
  - Color: 0xFFA500 (orange)
  - Description based on tool type:
    - Bash: show `input.command` in a code block; if `input.description` exists, add it as a field
    - Write: show "Writing to `{input.file_path}`"; if `input.content`, show first 500 chars as "Content Preview" field in code block
    - Edit: show "Editing `{input.file_path}`"; if `input.old_string` and `input.new_string`, show them as fields
    - Default: show `JSON.stringify(input, null, 2)` in a code block, truncated to 1000 chars
  - Footer text: "Respond within 5 minutes or this will be auto-denied"

- Export function `createPermissionButtons(toolUseId: string): ActionRowBuilder<ButtonBuilder>`
  - Creates an ActionRowBuilder with two buttons:
    - Allow button: customId `perm_allow_${toolUseId}`, label "Allow", style ButtonStyle.Success (green)
    - Deny button: customId `perm_deny_${toolUseId}`, label "Deny", style ButtonStyle.Danger (red)

Create src/discord/components/question-prompt.ts:
- Import ActionRowBuilder, StringSelectMenuBuilder, StringSelectMenuOptionBuilder, EmbedBuilder from discord.js

- Define types locally (or import from a shared types file):
  ```typescript
  interface QuestionOption { label: string; description: string; }
  interface Question { question: string; header: string; options: QuestionOption[]; multiSelect?: boolean; }
  interface AskUserQuestionInput { questions: Question[]; }
  ```
  Export these types.

- Export function `createQuestionEmbed(header: string, question: string): EmbedBuilder`
  - Title: header
  - Description: question
  - Color: 0x5865F2 (Discord blurple)

- Export function `createQuestionSelect(question: Question): ActionRowBuilder<StringSelectMenuBuilder>`
  - Creates a StringSelectMenuBuilder:
    - customId: `question_${question.header}`
    - placeholder: question.question (truncated to 100 chars for Discord limit)
    - minValues: 1
    - maxValues: question.multiSelect ? question.options.length : 1
    - Options: map question.options to StringSelectMenuOptionBuilder with label and description
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no errors
2. src/discord/components/permission-prompt.ts exports createPermissionEmbed and createPermissionButtons
3. src/discord/components/question-prompt.ts exports createQuestionEmbed, createQuestionSelect, and the Question/AskUserQuestionInput types
  </verify>
  <done>Discord component builders produce properly styled embeds, buttons, and select menus for permission requests and AskUserQuestion prompts. All compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create permission handler with prompt rendering and response collection</name>
  <files>src/bridge/permission-handler.ts</files>
  <action>
Create src/bridge/permission-handler.ts:

Import discord.js types: TextChannel, ThreadChannel, Message
Import component builders from ../discord/components/permission-prompt.js and ../discord/components/question-prompt.js
Import logger from ../logger.js

Define PermissionRequest and PermissionDecision types (same as in ipc-client.ts -- or use a shared types approach):
```typescript
interface PermissionRequest {
  tool_use_id: string;
  tool_name: string;
  input: Record<string, unknown>;
}

interface PermissionDecision {
  behavior: "allow" | "deny";
  updatedInput?: unknown;
  message?: string;
}
```

Export class PermissionHandler:
- Constructor takes a channelGetter function `() => TextChannel | ThreadChannel | null` (so the handler doesn't need the channel at construction time -- it's provided dynamically per request, allowing thread or channel targeting)
- Property: TIMEOUT_MS = 300_000 (5 minutes)

- Method `handlePermissionRequest(request: PermissionRequest, channel: TextChannel | ThreadChannel): Promise<PermissionDecision>`
  - If request.tool_name is "AskUserQuestion", delegate to handleAskUserQuestion
  - Otherwise:
    1. Build embed via createPermissionEmbed(request.tool_name, request.input)
    2. Build buttons via createPermissionButtons(request.tool_use_id)
    3. Send embed + buttons to the channel
    4. Call `promptMsg.awaitMessageComponent({ time: this.TIMEOUT_MS })`
    5. On button click:
       - Acknowledge immediately via `interaction.update({ components: [] })` (removes buttons, crucial for 3-second Discord timeout)
       - Update embed color: green (0x57F287) for allow, red (0xED4245) for deny
       - Update embed footer: "Allowed by user" or "Denied by user"
       - If customId starts with "perm_allow": return `{ behavior: "allow", updatedInput: request.input }`
       - If customId starts with "perm_deny": return `{ behavior: "deny", message: "User denied this action" }`
    6. On timeout (catch block from awaitMessageComponent):
       - Edit the message: remove buttons, update embed color to red, footer "Timed out - auto-denied"
       - Return `{ behavior: "deny", message: "Permission request timed out (5 minutes)" }`
       - Log the timeout at warn level

- Private method `handleAskUserQuestion(request: PermissionRequest, channel: TextChannel | ThreadChannel): Promise<PermissionDecision>`
  - Parse request.input as AskUserQuestionInput (has `questions` array)
  - Collect answers in a Record<string, string>
  - For each question in the array:
    1. Build embed via createQuestionEmbed(question.header, question.question)
    2. Build select menu via createQuestionSelect(question)
    3. Send embed + select menu to channel
    4. Await component interaction with 5-min timeout
    5. On selection: acknowledge, remove select menu, store answer: `answers[question.question] = interaction.values.join(", ")`
    6. On timeout: auto-deny the entire request
  - Return `{ behavior: "allow", updatedInput: { questions: request.input.questions, answers } }`
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no errors
2. src/bridge/permission-handler.ts exports PermissionHandler class
3. PermissionHandler has handlePermissionRequest method that handles both tool permissions and AskUserQuestion
4. Timeout is set to 300_000ms (5 minutes)
5. Button interactions are acknowledged before async work (3-second compliance)
  </verify>
  <done>PermissionHandler renders Discord embeds with buttons/select-menus, collects user responses, handles 5-minute timeout with auto-deny, and acknowledges interactions within 3 seconds. Both tool permission and AskUserQuestion flows are handled.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- all new files compile
2. Component builders produce valid Discord.js ActionRowBuilder instances
3. PermissionHandler handles both permission requests and AskUserQuestion
4. Timeout behavior: 5-minute auto-deny with visual feedback (embed color change, footer update)
5. Interaction acknowledgement happens before any async work
</verification>

<success_criteria>
- Permission prompts render with tool-specific content (Bash shows command, Write shows file path, etc.)
- Allow/Deny buttons have correct customIds for identification
- AskUserQuestion renders as select menus with all options
- Auto-deny fires after 5 minutes with notification
- All interactions acknowledged within 3 seconds
</success_criteria>

<output>
After completion, create `.planning/phases/02-interactive-proxy/02-02-SUMMARY.md`
</output>
