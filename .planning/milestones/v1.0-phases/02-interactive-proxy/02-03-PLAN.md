---
phase: 02-interactive-proxy
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/config.ts
  - .env.example
  - src/claude/types.ts
  - src/claude/process.ts
autonomous: true

must_haves:
  truths:
    - "Claude CLI spawns with --mcp-config pointing to the compiled permission server"
    - "Claude CLI spawns with --permission-prompt-tool mcp__permsrv__permission_prompt"
    - "IPC port is configurable via GSD_IPC_PORT environment variable"
    - "MCP server receives the IPC port via environment variable in the mcp config"
  artifacts:
    - path: "src/config.ts"
      provides: "IPC port configuration"
      contains: "ipcPort"
    - path: "src/claude/types.ts"
      provides: "Updated SpawnOptions with ipcPort"
      contains: "ipcPort"
    - path: "src/claude/process.ts"
      provides: "Claude CLI spawning with MCP config and permission-prompt-tool flags"
      contains: "permission-prompt-tool"
  key_links:
    - from: "src/claude/process.ts"
      to: "src/mcp/permission-server.ts"
      via: "--mcp-config JSON referencing compiled permission-server.js path"
      pattern: "permission-server"
    - from: "src/claude/process.ts"
      to: "src/config.ts"
      via: "ipcPort passed through SpawnOptions"
      pattern: "ipcPort"
---

<objective>
Wire the Claude CLI subprocess spawning to use the MCP permission server by adding --mcp-config and --permission-prompt-tool flags, and make the IPC port configurable.

Purpose: This connects the MCP permission server (created in Plan 01) to the Claude CLI invocation. Without these flags, Claude would not route permission requests through our custom MCP server, and the entire permission bridge would be unused.

Output: Modified config.ts (IPC port), types.ts (SpawnOptions), process.ts (MCP flags), and .env.example (documentation).
</objective>

<execution_context>
@/Users/erictrang/.claude/get-shit-done/workflows/execute-plan.md
@/Users/erictrang/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-interactive-proxy/02-RESEARCH.md
@.planning/phases/02-interactive-proxy/02-01-SUMMARY.md
@src/config.ts
@src/claude/types.ts
@src/claude/process.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IPC port config and update SpawnOptions type</name>
  <files>src/config.ts, .env.example, src/claude/types.ts</files>
  <action>
Modify src/config.ts:
- Add GSD_IPC_PORT as an OPTIONAL env var (not in the required array -- it has a default)
- Add `ipcPort` to the config export: `ipcPort: parseInt(process.env.GSD_IPC_PORT || "9824", 10)`
- The port 9824 is the default; it can be overridden via .env

Modify .env.example:
- Add a new section after the existing Discord vars:
  ```
  # IPC Configuration (optional)
  # Port for MCP permission server <-> bot communication
  # GSD_IPC_PORT=9824
  ```
  (Commented out since it has a default)

Modify src/claude/types.ts:
- Add `ipcPort: number` to the SpawnOptions interface (required, not optional -- the caller must always provide it)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. config.ts exports ipcPort with default value 9824
3. SpawnOptions has ipcPort: number
4. .env.example documents GSD_IPC_PORT
  </verify>
  <done>IPC port is configurable with sensible default. SpawnOptions type requires ipcPort for Claude process spawning.</done>
</task>

<task type="auto">
  <name>Task 2: Add MCP config and permission-prompt-tool flags to Claude CLI spawning</name>
  <files>src/claude/process.ts</files>
  <action>
Modify src/claude/process.ts:
- Add `import path from "node:path"` and `import { fileURLToPath } from "node:url"` (for resolving the permission-server.js path)
- After session continuity flags, before the core flags, build the MCP config:

```typescript
// Build MCP config for permission server
const mcpConfig = JSON.stringify({
  mcpServers: {
    permsrv: {
      command: process.execPath, // Uses the same Node.js binary (node or tsx)
      args: [path.resolve(
        path.dirname(fileURLToPath(import.meta.url)),
        "../mcp/permission-server.js"
      )],
      env: {
        GSD_IPC_PORT: String(options.ipcPort),
      },
    },
  },
});
```

- Add the MCP flags to the args array, BEFORE the --allowedTools flag:
  ```typescript
  "--mcp-config", mcpConfig,
  "--permission-prompt-tool", "mcp__permsrv__permission_prompt",
  ```

- Update the function call to use options.ipcPort (it's now required in SpawnOptions)

IMPORTANT NOTES:
- The path resolution uses import.meta.url to find the compiled permission-server.js relative to process.ts (both in dist/ after compilation, or both in src/ during tsx dev mode)
- process.execPath ensures the same Node.js runtime is used (handles both `node` and `tsx` cases)
- The mcpConfig is passed as a JSON string directly to --mcp-config (not a file path)
- Keep stdin as "inherit" per Phase 1 finding -- Claude CLI requires it
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. process.ts includes --mcp-config flag with mcpServers.permsrv configuration
3. process.ts includes --permission-prompt-tool mcp__permsrv__permission_prompt
4. MCP config passes GSD_IPC_PORT env var to the permission server subprocess
5. Path to permission-server.js is resolved relative to the current file using import.meta.url
  </verify>
  <done>Claude CLI spawns with MCP permission server config and permission-prompt-tool flag. The MCP server subprocess will receive the IPC port via environment variable and can forward permission requests to the bot.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes -- all modified files compile
2. `npm run build` succeeds
3. process.ts spawn args include --mcp-config and --permission-prompt-tool
4. MCP config JSON correctly references permission-server.js and passes GSD_IPC_PORT
5. config.ts exports ipcPort with default 9824
6. .env.example documents the optional GSD_IPC_PORT variable
</verification>

<success_criteria>
- Claude CLI invocation includes MCP config pointing to compiled permission server
- Permission-prompt-tool flag is set to mcp__permsrv__permission_prompt
- IPC port flows from config.ts -> SpawnOptions -> MCP config env var -> permission server process
- Existing Claude CLI functionality (session continuity, stream-json, allowedTools) is preserved
</success_criteria>

<output>
After completion, create `.planning/phases/02-interactive-proxy/02-03-SUMMARY.md`
</output>
